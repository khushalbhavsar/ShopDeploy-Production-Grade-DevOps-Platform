/**
 * ============================================================================
 * ShopDeploy GitOps Pipeline (ArgoCD Integration)
 * ============================================================================
 * This pipeline is a pure GitOps approach - it ONLY updates the GitOps
 * repository. ArgoCD handles all deployments automatically.
 * 
 * Use this instead of Jenkinsfile-cd when using ArgoCD for deployments.
 * ============================================================================
 * 
 * Flow:
 * CI Pipeline â†’ Build Image â†’ Push to ECR â†’ This Pipeline â†’ Update GitOps â†’ ArgoCD Deploys
 * 
 * ============================================================================
 */

pipeline {
    agent any

    environment {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Git Configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        GITOPS_REPO = 'https://github.com/khushalbhavsar/ShopDeploy-Cloud-Native-DevOps-Platform.git'
        GITOPS_BRANCH = 'main'
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AWS Configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        AWS_REGION = 'us-east-1'
        AWS_ACCOUNT_ID = credentials('aws-account-id')
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ECR Configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        ECR_BACKEND_REPO = 'shopdeploy-prod-backend'
        ECR_FRONTEND_REPO = 'shopdeploy-prod-frontend'
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EKS Configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EKS_CLUSTER_NAME = 'shopdeploy-prod-eks'
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Slack Integration (set to 'true' when configured)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        SLACK_ENABLED = 'false'
    }

    options {
        timeout(time: 15, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '30'))
        timestamps()
        disableConcurrentBuilds()
    }

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'staging', 'prod'],
            description: 'ğŸŒ Target deployment environment'
        )
        string(
            name: 'IMAGE_TAG',
            defaultValue: '',
            description: 'ğŸ·ï¸ Docker image tag to deploy (e.g., 42-a1b2c3d). Leave empty to fetch latest from AWS SSM.'
        )
        string(
            name: 'BACKEND_IMAGE_TAG',
            defaultValue: '',
            description: 'ğŸ”§ Backend image tag (if different from IMAGE_TAG)'
        )
        string(
            name: 'FRONTEND_IMAGE_TAG',
            defaultValue: '',
            description: 'ğŸ¨ Frontend image tag (if different from IMAGE_TAG)'
        )
        booleanParam(
            name: 'DRY_RUN',
            defaultValue: false,
            description: 'ğŸ§ª Perform dry-run without pushing changes'
        )
    }

    stages {
        //======================================================================
        // Stage 1: Environment Setup
        //======================================================================
        stage('Environment Setup') {
            steps {
                script {
                    // Set environment-specific variables
                    switch(params.ENVIRONMENT) {
                        case 'prod':
                            env.ENV_EMOJI = 'ğŸ”´'
                            env.ENV_COLOR = 'danger'
                            env.K8S_NAMESPACE = 'shopdeploy-prod'
                            env.API_URL = 'https://api.shopdeploy.com/api'
                            env.FRONTEND_URL = 'https://shopdeploy.com'
                            env.REPLICAS = '3'
                            env.REQUIRE_APPROVAL = 'true'
                            break
                        case 'staging':
                            env.ENV_EMOJI = 'ğŸŸ¡'
                            env.ENV_COLOR = 'warning'
                            env.K8S_NAMESPACE = 'shopdeploy-staging'
                            env.API_URL = 'https://api-staging.shopdeploy.com/api'
                            env.FRONTEND_URL = 'https://staging.shopdeploy.com'
                            env.REPLICAS = '2'
                            env.REQUIRE_APPROVAL = 'false'
                            break
                        case 'dev':
                        default:
                            env.ENV_EMOJI = 'ğŸŸ¢'
                            env.ENV_COLOR = 'good'
                            env.K8S_NAMESPACE = 'shopdeploy-dev'
                            env.API_URL = 'https://api-dev.shopdeploy.com/api'
                            env.FRONTEND_URL = 'https://dev.shopdeploy.com'
                            env.REPLICAS = '1'
                            env.REQUIRE_APPROVAL = 'false'
                            break
                    }
                    
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "${env.ENV_EMOJI} GITOPS PIPELINE - ${params.ENVIRONMENT.toUpperCase()}"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "Namespace: ${env.K8S_NAMESPACE}"
                    echo "API URL: ${env.API_URL}"
                    echo "Frontend URL: ${env.FRONTEND_URL}"
                    echo "Replicas: ${env.REPLICAS}"
                    if (params.DRY_RUN) {
                        echo "âš ï¸ DRY RUN MODE - No changes will be pushed"
                    }
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
            }
        }

        //======================================================================
        // Stage 2: Validate & Get Image Tags
        //======================================================================
        stage('Validate') {
            steps {
                script {
                    // Determine image tags
                    if (params.IMAGE_TAG?.trim()) {
                        env.BACKEND_TAG = params.BACKEND_IMAGE_TAG?.trim() ?: params.IMAGE_TAG.trim()
                        env.FRONTEND_TAG = params.FRONTEND_IMAGE_TAG?.trim() ?: params.IMAGE_TAG.trim()
                        echo "Using provided IMAGE_TAG: ${params.IMAGE_TAG}"
                    } else {
                        // Fetch from AWS Parameter Store
                        echo "Fetching latest IMAGE_TAG from AWS Parameter Store..."
                        withCredentials([[
                            $class: 'AmazonWebServicesCredentialsBinding',
                            credentialsId: 'aws-credentials',
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                        ]]) {
                            env.BACKEND_TAG = sh(
                                script: '''
                                    aws ssm get-parameter \
                                        --name "/shopdeploy/latest-image-tag" \
                                        --query 'Parameter.Value' \
                                        --output text \
                                        --region ${AWS_REGION}
                                ''',
                                returnStdout: true
                            ).trim()
                            env.FRONTEND_TAG = env.BACKEND_TAG
                        }
                        echo "Retrieved IMAGE_TAG from Parameter Store: ${env.BACKEND_TAG}"
                    }

                    // Validate tags
                    if (!env.BACKEND_TAG || !env.FRONTEND_TAG || env.BACKEND_TAG == 'null') {
                        error("âŒ Image tag is required! Please provide IMAGE_TAG or ensure SSM parameter exists.")
                    }

                    // Set full image URLs
                    env.BACKEND_IMAGE = "${ECR_REGISTRY}/${ECR_BACKEND_REPO}:${env.BACKEND_TAG}"
                    env.FRONTEND_IMAGE = "${ECR_REGISTRY}/${ECR_FRONTEND_REPO}:${env.FRONTEND_TAG}"

                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "ğŸ“¦ Image Configuration:"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "Backend Tag: ${env.BACKEND_TAG}"
                    echo "Frontend Tag: ${env.FRONTEND_TAG}"
                    echo "Backend Image: ${env.BACKEND_IMAGE}"
                    echo "Frontend Image: ${env.FRONTEND_IMAGE}"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
            }
        }

        //======================================================================
        // Stage 3: Verify Images Exist in ECR
        //======================================================================
        stage('Verify Images') {
            steps {
                echo "ğŸ” Verifying images exist in ECR..."
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-credentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    script {
                        // Verify backend image
                        def backendExists = sh(
                            script: """
                                aws ecr describe-images \
                                    --repository-name ${ECR_BACKEND_REPO} \
                                    --image-ids imageTag=${env.BACKEND_TAG} \
                                    --region ${AWS_REGION} > /dev/null 2>&1 && echo "true" || echo "false"
                            """,
                            returnStdout: true
                        ).trim()
                        
                        if (backendExists != 'true') {
                            error("âŒ Backend image not found in ECR: ${env.BACKEND_TAG}")
                        }
                        echo "âœ… Backend image verified: ${env.BACKEND_TAG}"
                        
                        // Verify frontend image
                        def frontendExists = sh(
                            script: """
                                aws ecr describe-images \
                                    --repository-name ${ECR_FRONTEND_REPO} \
                                    --image-ids imageTag=${env.FRONTEND_TAG} \
                                    --region ${AWS_REGION} > /dev/null 2>&1 && echo "true" || echo "false"
                            """,
                            returnStdout: true
                        ).trim()
                        
                        if (frontendExists != 'true') {
                            error("âŒ Frontend image not found in ECR: ${env.FRONTEND_TAG}")
                        }
                        echo "âœ… Frontend image verified: ${env.FRONTEND_TAG}"
                    }
                }
            }
        }

        //======================================================================
        // Stage 4: Production Approval Gate
        //======================================================================
        stage('Production Approval') {
            when {
                expression { params.ENVIRONMENT == 'prod' && !params.DRY_RUN }
            }
            steps {
                script {
                    echo "ğŸ”´ PRODUCTION DEPLOYMENT REQUIRES APPROVAL"
                    
                    def approvalMessage = """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”´ PRODUCTION GITOPS UPDATE APPROVAL REQUIRED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Environment: PRODUCTION
Namespace: ${env.K8S_NAMESPACE}

Backend Image: ${env.BACKEND_IMAGE}
Frontend Image: ${env.FRONTEND_IMAGE}

This will update the GitOps repository and ArgoCD will
automatically deploy to PRODUCTION.

âš ï¸ This action cannot be undone without a git revert!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: approvalMessage,
                            ok: 'ğŸš€ Approve Production Update',
                            submitter: 'admin,devops-lead,devops-team'
                        )
                    }
                    echo "âœ… Production deployment approved!"
                }
            }
        }

        //======================================================================
        // Stage 5: Checkout GitOps Repository
        //======================================================================
        stage('Checkout GitOps Repo') {
            steps {
                echo "ğŸ“¥ Checking out GitOps repository..."
                
                // Clean workspace before checkout
                cleanWs()
                
                // Checkout using Git SCM
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${GITOPS_BRANCH}"]],
                    extensions: [
                        [$class: 'CleanBeforeCheckout'],
                        [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]
                    ],
                    userRemoteConfigs: [[
                        credentialsId: 'github-credentials',
                        url: "${GITOPS_REPO}"
                    ]]
                ])
                
                echo "âœ… Repository checked out successfully"
                
                // Show current state
                sh '''
                    echo "Current branch:"
                    git branch
                    echo ""
                    echo "GitOps folder structure:"
                    ls -la gitops/ || echo "gitops folder not found"
                '''
            }
        }

        //======================================================================
        // Stage 6: Update GitOps Values
        //======================================================================
        stage('Update GitOps') {
            steps {
                echo "ğŸ”„ Updating GitOps repository..."
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'github-credentials',
                            usernameVariable: 'GIT_USER',
                            passwordVariable: 'GIT_TOKEN'
                        )
                    ]) {
                        sh """
                            # Configure git
                            git config user.email "jenkins@shopdeploy.com"
                            git config user.name "Jenkins GitOps Bot"

                            # Show current values
                            echo "ğŸ“‹ Current backend values:"
                            cat gitops/${params.ENVIRONMENT}/backend-values.yaml | grep -A2 "image:" || true
                            
                            echo ""
                            echo "ğŸ“‹ Current frontend values:"
                            cat gitops/${params.ENVIRONMENT}/frontend-values.yaml | grep -A2 "image:" || true

                            # Update backend values
                            echo ""
                            echo "ğŸ“ Updating backend image tag to ${env.BACKEND_TAG}..."
                            sed -i 's|tag:.*|tag: "${env.BACKEND_TAG}"|g' gitops/${params.ENVIRONMENT}/backend-values.yaml

                            # Update frontend values  
                            echo "ğŸ“ Updating frontend image tag to ${env.FRONTEND_TAG}..."
                            sed -i 's|tag:.*|tag: "${env.FRONTEND_TAG}"|g' gitops/${params.ENVIRONMENT}/frontend-values.yaml

                            # Show updated values
                            echo ""
                            echo "ğŸ“‹ Updated backend values:"
                            cat gitops/${params.ENVIRONMENT}/backend-values.yaml | grep -A2 "image:" || true
                            
                            echo ""
                            echo "ğŸ“‹ Updated frontend values:"
                            cat gitops/${params.ENVIRONMENT}/frontend-values.yaml | grep -A2 "image:" || true

                            # Show diff
                            echo ""
                            echo "ğŸ“‹ Git diff:"
                            git diff gitops/${params.ENVIRONMENT}/

                            # Check if there are changes
                            if git diff --quiet gitops/${params.ENVIRONMENT}/; then
                                echo "âš ï¸ No changes detected - values already up to date"
                            else
                                # Stage changes
                                git add gitops/${params.ENVIRONMENT}/
                                
                                # Commit changes
                                git commit -m "ğŸš€ [GitOps] Deploy to ${params.ENVIRONMENT}

Environment: ${params.ENVIRONMENT}
Namespace: ${env.K8S_NAMESPACE}
Backend: ${env.BACKEND_TAG}
Frontend: ${env.FRONTEND_TAG}

Pipeline: #${BUILD_NUMBER}

[skip ci]"

                                if [ "${params.DRY_RUN}" = "true" ]; then
                                    echo "âš ï¸ DRY RUN - Skipping push"
                                    echo "Would push to: ${GITOPS_REPO}"
                                else
                                    # Push to remote
                                    echo "ğŸ“¤ Pushing changes to remote..."
                                    git push https://\${GIT_USER}:\${GIT_TOKEN}@github.com/khushalbhavsar/ShopDeploy-Cloud-Native-DevOps-Platform.git HEAD:${GITOPS_BRANCH}
                                    echo "âœ… Changes pushed successfully!"
                                fi
                            fi
                        """
                    }
                }
            }
        }

        //======================================================================
        // Stage 7: Verify ArgoCD Sync
        //======================================================================
        stage('Verify ArgoCD Sync') {
            when {
                expression { !params.DRY_RUN }
            }
            steps {
                echo "â³ Waiting for ArgoCD to detect changes..."
                script {
                    // Give ArgoCD time to detect changes
                    sleep(time: 30, unit: 'SECONDS')

                    // Check ArgoCD application status
                    sh """
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo "ğŸ”„ ArgoCD Sync Status"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        
                        # Check if argocd CLI is available
                        if command -v argocd &> /dev/null; then
                            echo "Checking ArgoCD application status..."
                            
                            # Refresh and get backend app status
                            echo ""
                            echo "Backend Application:"
                            argocd app get shopdeploy-backend-${params.ENVIRONMENT} --refresh 2>/dev/null || echo "  âš ï¸ Could not fetch status"
                            
                            # Refresh and get frontend app status
                            echo ""
                            echo "Frontend Application:"
                            argocd app get shopdeploy-frontend-${params.ENVIRONMENT} --refresh 2>/dev/null || echo "  âš ï¸ Could not fetch status"
                        else
                            echo "â„¹ï¸ ArgoCD CLI not installed on Jenkins agent"
                            echo ""
                            echo "Please verify deployment in ArgoCD UI:"
                            echo "  ğŸ“¦ Applications to check:"
                            echo "     - shopdeploy-backend-${params.ENVIRONMENT}"
                            echo "     - shopdeploy-frontend-${params.ENVIRONMENT}"
                            echo ""
                            echo "  ğŸ¯ Expected State:"
                            echo "     Namespace: ${env.K8S_NAMESPACE}"
                            echo "     Backend Image: ${env.BACKEND_IMAGE}"
                            echo "     Frontend Image: ${env.FRONTEND_IMAGE}"
                        fi
                        
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    """
                }
            }
        }
    }

    //==========================================================================
    // Post-Build Actions
    //==========================================================================
    post {
        success {
            script {
                def dryRunNote = params.DRY_RUN ? " (DRY RUN)" : ""
                
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "${env.ENV_EMOJI} GITOPS UPDATE SUCCESS${dryRunNote}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Environment: ${params.ENVIRONMENT.toUpperCase()}"
                echo "Namespace: ${env.K8S_NAMESPACE}"
                echo "Backend Image: ${env.BACKEND_IMAGE}"
                echo "Frontend Image: ${env.FRONTEND_IMAGE}"
                echo ""
                if (!params.DRY_RUN) {
                    echo "ğŸ”„ ArgoCD will automatically sync and deploy the changes."
                    echo "ğŸ“Š Check ArgoCD UI for deployment status."
                } else {
                    echo "âš ï¸ DRY RUN completed - no changes were pushed."
                }
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                // Slack notification
                if (env.SLACK_ENABLED == 'true' && !params.DRY_RUN) {
                    try {
                        slackSend(
                            channel: '#deployments',
                            color: env.ENV_COLOR,
                            message: """${env.ENV_EMOJI} *GitOps Update Success*
â€¢ Environment: ${params.ENVIRONMENT.toUpperCase()}
â€¢ Namespace: ${env.K8S_NAMESPACE}
â€¢ Backend: `${env.BACKEND_TAG}`
â€¢ Frontend: `${env.FRONTEND_TAG}`
â€¢ Build: <${BUILD_URL}|#${BUILD_NUMBER}>"""
                        )
                    } catch (Exception e) {
                        echo "Slack notification failed: ${e.message}"
                    }
                }
            }
        }

        failure {
            script {
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âŒ GITOPS UPDATE FAILED"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Environment: ${params.ENVIRONMENT.toUpperCase()}"
                echo "Build: #${BUILD_NUMBER}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                // Slack notification
                if (env.SLACK_ENABLED == 'true') {
                    try {
                        slackSend(
                            channel: '#deployments',
                            color: 'danger',
                            message: """âŒ *GitOps Update Failed*
â€¢ Environment: ${params.ENVIRONMENT.toUpperCase()}
â€¢ Build: <${BUILD_URL}|#${BUILD_NUMBER}>
â€¢ <${BUILD_URL}console|View Logs>"""
                        )
                    } catch (Exception e) {
                        echo "Slack notification failed: ${e.message}"
                    }
                }
            }
        }

        aborted {
            script {
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âš ï¸ GITOPS UPDATE ABORTED"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "Environment: ${params.ENVIRONMENT.toUpperCase()}"
                echo "Build: #${BUILD_NUMBER}"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
        }

        always {
            // Clean up workspace
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true
            )
        }
    }
}
