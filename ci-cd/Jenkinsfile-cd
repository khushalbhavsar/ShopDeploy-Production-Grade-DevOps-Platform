/**
 * ============================================================================
 * ShopDeploy CD Pipeline (Build Once, Deploy Many)
 * ============================================================================
 * Responsibilities:
 * - Accept IMAGE_TAG from CI pipeline
 * - Deploy to target environment using Helm
 * - Production approval gate
 * - Run smoke tests
 * - Auto rollback on failure
 * ============================================================================
 * 
 * Golden Rule: Build once, deploy everywhere. Never rebuild for production.
 * 
 * ============================================================================
 */

pipeline {
    // Run on Jenkins agent with Docker, kubectl, and Helm installed
    agent any

    environment {
        // AWS Configuration
        AWS_REGION = 'us-east-1'
        
        // ECR Configuration
        ECR_BACKEND_REPO = "shopdeploy-prod-backend"
        ECR_FRONTEND_REPO = "shopdeploy-prod-frontend"

        // EKS Configuration
        EKS_CLUSTER_NAME = 'shopdeploy-prod-eks'
        
        // Docker BuildKit for faster builds
        DOCKER_BUILDKIT = '1'
        
        // Slack integration (set to 'true' when configured)
        SLACK_ENABLED = 'false'
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '50'))
        timestamps()
    }

    parameters {
        string(
            name: 'IMAGE_TAG',
            defaultValue: '',
            description: 'Docker image tag to deploy (e.g., 42-a1b2c3d). Leave empty to use latest from Parameter Store.'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'staging', 'prod'],
            description: 'Target deployment environment'
        )
        booleanParam(
            name: 'SKIP_SMOKE_TESTS',
            defaultValue: false,
            description: 'Skip smoke tests after deployment'
        )
        booleanParam(
            name: 'DRY_RUN',
            defaultValue: false,
            description: 'Perform dry-run without actual deployment'
        )
    }

    stages {
        //======================================================================
        // Stage 1: Initialize
        //======================================================================
        stage('Initialize') {
            steps {
                echo 'ğŸš€ Initializing CD Pipeline...'
                script {
                    // FIX 7: Environment-specific namespace
                    env.K8S_NAMESPACE = "shopdeploy-${params.ENVIRONMENT}"
                    echo "ğŸ“¦ Target namespace: ${env.K8S_NAMESPACE}"
                    
                    // Get IMAGE_TAG from parameter or Parameter Store
                    if (params.IMAGE_TAG?.trim()) {
                        env.DEPLOY_IMAGE_TAG = params.IMAGE_TAG.trim()
                        echo "ğŸ“¦ Using provided IMAGE_TAG: ${env.DEPLOY_IMAGE_TAG}"
                    } else {
                        echo "ğŸ“¦ Fetching latest IMAGE_TAG from Parameter Store..."
                        withCredentials([
                            string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                            [$class: 'AmazonWebServicesCredentialsBinding',
                             credentialsId: 'aws-credentials',
                             accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                             secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                        ]) {
                            env.DEPLOY_IMAGE_TAG = sh(
                                script: '''
                                    aws ssm get-parameter \
                                        --name "/shopdeploy/latest-image-tag" \
                                        --query 'Parameter.Value' \
                                        --output text \
                                        --region us-east-1
                                ''',
                                returnStdout: true
                            ).trim()
                            // Set ECR_REGISTRY with account ID
                            env.ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com"
                        }
                        echo "ğŸ“¦ Retrieved IMAGE_TAG from Parameter Store: ${env.DEPLOY_IMAGE_TAG}"
                    }
                    
                    // Validate IMAGE_TAG
                    if (!env.DEPLOY_IMAGE_TAG || env.DEPLOY_IMAGE_TAG == 'null') {
                        error("âŒ IMAGE_TAG is required. Please provide a valid image tag.")
                    }
                    
                    // Set ECR_REGISTRY if not already set (when IMAGE_TAG was provided)
                    if (!env.ECR_REGISTRY) {
                        withCredentials([string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID')]) {
                            env.ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com"
                        }
                    }
                    
                    // Set full image URLs
                    env.BACKEND_IMAGE = "${env.ECR_REGISTRY}/${ECR_BACKEND_REPO}:${env.DEPLOY_IMAGE_TAG}"
                    env.FRONTEND_IMAGE = "${env.ECR_REGISTRY}/${ECR_FRONTEND_REPO}:${env.DEPLOY_IMAGE_TAG}"
                    
                    echo """
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘  ğŸ“‹ DEPLOYMENT CONFIGURATION                              â•‘
                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                    â•‘  Environment: ${params.ENVIRONMENT}                       
                    â•‘  Namespace: ${env.K8S_NAMESPACE}                          
                    â•‘  Image Tag: ${env.DEPLOY_IMAGE_TAG}                       
                    â•‘  Dry Run: ${params.DRY_RUN}                               
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                }
            }
        }

        //======================================================================
        // Stage 2: Verify Tools & ECR Login
        //======================================================================
        stage('Verify Tools') {
            steps {
                echo 'ğŸ”§ Verifying required tools...'
                sh '''
                    echo "Checking required tools..."
                    echo "========================="
                    
                    echo "ğŸ³ Docker:"
                    docker --version
                    
                    echo "
â˜ï¸ AWS CLI:"
                    aws --version
                    
                    echo "
â˜¸ï¸ kubectl:"
                    kubectl version --client || echo "âš ï¸ kubectl not available"
                    
                    echo "
âš™ï¸ Helm:"
                    helm version --short || echo "âš ï¸ Helm not available"
                    
                    echo "
âœ… Tool verification complete"
                '''
            }
        }

        //======================================================================
        // Stage 3: Verify Images Exist
        //======================================================================
        stage('Verify Images') {
            steps {
                echo 'ğŸ” Verifying images exist in ECR...'
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding',
                     credentialsId: 'aws-credentials',
                     accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                     secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                ]) {
                    sh '''
                        # Login to ECR (FIX 10: single login point)
                        echo "ğŸ” Logging into ECR..."
                        aws ecr get-login-password --region us-east-1 | \
                            docker login --username AWS --password-stdin ${ECR_REGISTRY}
                        
                        # Verify backend image exists
                        echo "ğŸ” Checking backend image..."
                        aws ecr describe-images \
                            --repository-name ${ECR_BACKEND_REPO} \
                            --image-ids imageTag=${DEPLOY_IMAGE_TAG} \
                            --region us-east-1 > /dev/null || \
                            { echo "âŒ Backend image not found: ${DEPLOY_IMAGE_TAG}"; exit 1; }
                        echo "âœ… Backend image verified"
                        
                        # Verify frontend image exists
                        echo "ğŸ” Checking frontend image..."
                        aws ecr describe-images \
                            --repository-name ${ECR_FRONTEND_REPO} \
                            --image-ids imageTag=${DEPLOY_IMAGE_TAG} \
                            --region us-east-1 > /dev/null || \
                            { echo "âŒ Frontend image not found: ${DEPLOY_IMAGE_TAG}"; exit 1; }
                        echo "âœ… Frontend image verified"
                    '''
                }
            }
        }

        //======================================================================
        // Stage 4: Production Approval
        //======================================================================
        stage('Production Approval') {
            steps {
                script {
                    if (params.ENVIRONMENT == 'prod' && !params.DRY_RUN) {
                        echo 'â³ Waiting for production deployment approval...'
                        
                        def approvalMessage = """
                        ğŸš€ PRODUCTION DEPLOYMENT REQUEST
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Image Tag: ${env.DEPLOY_IMAGE_TAG}
                        Backend: ${env.BACKEND_IMAGE}
                        Frontend: ${env.FRONTEND_IMAGE}
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        
                        âš ï¸ This will deploy to PRODUCTION.
                        Please review and approve.
                        """
                        
                        echo approvalMessage
                        
                        // FIX 8: Only send Slack if enabled
                        if (env.SLACK_ENABLED == 'true') {
                            slackSend(
                                channel: '#deployments',
                                color: 'warning',
                                message: "ğŸ”” Production deployment approval needed | Tag: ${env.DEPLOY_IMAGE_TAG} | <${BUILD_URL}input|Approve/Reject>"
                            )
                        }
                        
                        timeout(time: 30, unit: 'MINUTES') {
                            input(
                                message: "Deploy ${env.DEPLOY_IMAGE_TAG} to PRODUCTION?",
                                ok: 'Approve Deployment',
                                submitter: 'admin,devops-team',
                                submitterParameter: 'APPROVER'
                            )
                        }
                        
                        echo "âœ… Production deployment approved by ${env.APPROVER}"
                        
                        // FIX 8: Only send Slack if enabled
                        if (env.SLACK_ENABLED == 'true') {
                            slackSend(
                                channel: '#deployments',
                                color: 'good',
                                message: "âœ… Production deployment approved by ${env.APPROVER} | Tag: ${env.DEPLOY_IMAGE_TAG}"
                            )
                        }
                    } else {
                        echo "â„¹ï¸ Production approval not required for ${params.ENVIRONMENT} environment"
                    }
                }
            }
        }

        //======================================================================
        // Stage 5: Capture Current State (for Rollback)
        //======================================================================
        stage('Capture Rollback Info') {
            steps {
                script {
                    if (params.DRY_RUN) {
                        echo 'â„¹ï¸ Dry run mode - skipping rollback info capture'
                        env.BACKEND_REVISION = '0'
                        env.FRONTEND_REVISION = '0'
                    } else {
                        echo 'ğŸ“¸ Capturing current deployment state for rollback...'
                        withCredentials([
                            [$class: 'AmazonWebServicesCredentialsBinding',
                             credentialsId: 'aws-credentials',
                             accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                             secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                        ]) {
                            sh '''
                                # Configure kubectl for EKS
                                aws eks update-kubeconfig --region us-east-1 --name ${EKS_CLUSTER_NAME}
                            '''
                            
                            // Get current Helm release revisions
                            env.BACKEND_REVISION = sh(
                                script: "helm history shopdeploy-backend -n ${env.K8S_NAMESPACE} --max 1 -o json 2>/dev/null | jq -r '.[0].revision' || echo '0'",
                                returnStdout: true
                            ).trim()
                            
                            env.FRONTEND_REVISION = sh(
                                script: "helm history shopdeploy-frontend -n ${env.K8S_NAMESPACE} --max 1 -o json 2>/dev/null | jq -r '.[0].revision' || echo '0'",
                                returnStdout: true
                            ).trim()
                            
                            echo "ğŸ“‹ Current backend revision: ${env.BACKEND_REVISION}"
                            echo "ğŸ“‹ Current frontend revision: ${env.FRONTEND_REVISION}"
                        }
                    }
                }
            }
        }

        //======================================================================
        // Stage 6: Deploy to Environment
        //======================================================================
        stage('Deploy') {
            steps {
                echo "ğŸš€ Deploying to ${params.ENVIRONMENT}..."
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding',
                     credentialsId: 'aws-credentials',
                     accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                     secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                ]) {
                    script {
                        // FIX 6: Use --atomic for auto-rollback on failure
                        def helmArgs = params.DRY_RUN ? '--dry-run' : '--atomic'
                        def valuesFile = "values-${params.ENVIRONMENT}.yaml"
                        
                        sh """
                            # Configure kubectl for EKS
                            aws eks update-kubeconfig --region us-east-1 --name ${EKS_CLUSTER_NAME}
                            
                            # Create namespace if not exists
                            kubectl create namespace ${env.K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                            
                            # Deploy backend with --atomic (auto-rollback on failure)
                            echo "ğŸ“¦ Deploying backend..."
                            helm upgrade --install shopdeploy-backend ./helm/backend \
                                --namespace ${env.K8S_NAMESPACE} \
                                --values ./helm/backend/${valuesFile} \
                                --set image.repository=${env.ECR_REGISTRY}/${ECR_BACKEND_REPO} \
                                --set image.tag=${env.DEPLOY_IMAGE_TAG} \
                                --set global.environment=${params.ENVIRONMENT} \
                                --wait \
                                --timeout 10m \
                                ${helmArgs}
                            
                            # Deploy frontend with --atomic (auto-rollback on failure)
                            echo "ğŸ¨ Deploying frontend..."
                            helm upgrade --install shopdeploy-frontend ./helm/frontend \
                                --namespace ${env.K8S_NAMESPACE} \
                                --values ./helm/frontend/${valuesFile} \
                                --set image.repository=${env.ECR_REGISTRY}/${ECR_FRONTEND_REPO} \
                                --set image.tag=${env.DEPLOY_IMAGE_TAG} \
                                --set global.environment=${params.ENVIRONMENT} \
                                --wait \
                                --timeout 10m \
                                ${helmArgs}
                            
                            echo "âœ… Deployment completed"
                        """
                    }
                }
            }
        }

        //======================================================================
        // Stage 7: Smoke Tests
        //======================================================================
        stage('Smoke Tests') {
            steps {
                script {
                    if (params.SKIP_SMOKE_TESTS) {
                        echo 'â„¹ï¸ Smoke tests skipped by user request'
                    } else if (params.DRY_RUN) {
                        echo 'â„¹ï¸ Dry run mode - skipping smoke tests'
                    } else {
                        echo 'ğŸ”¬ Running smoke tests...'
                        withCredentials([
                            [$class: 'AmazonWebServicesCredentialsBinding',
                             credentialsId: 'aws-credentials',
                             accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                             secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                        ]) {
                            sh """
                                # Configure kubectl
                                aws eks update-kubeconfig --region us-east-1 --name ${EKS_CLUSTER_NAME}
                                
                                echo "ğŸ“‹ Checking deployment status..."
                                
                                # Check pod status
                                echo "ğŸ” Pod Status:"
                                kubectl get pods -n ${env.K8S_NAMESPACE} -o wide
                                
                                # Wait for backend rollout
                                echo "â³ Waiting for backend rollout..."
                                kubectl rollout status deployment/shopdeploy-backend -n ${env.K8S_NAMESPACE} --timeout=300s
                                
                                # Wait for frontend rollout
                                echo "â³ Waiting for frontend rollout..."
                                kubectl rollout status deployment/shopdeploy-frontend -n ${env.K8S_NAMESPACE} --timeout=300s
                                
                                # Get service endpoints
                                echo "ğŸŒ Service Endpoints:"
                                kubectl get svc -n ${env.K8S_NAMESPACE}
                                
                                # Get ingress
                                echo "ğŸšª Ingress:"
                                kubectl get ingress -n ${env.K8S_NAMESPACE} || echo "No ingress configured"
                                
                                # Verify pods are running
                                echo "ğŸ¥ Health check..."
                                BACKEND_READY=\$(kubectl get pods -n ${env.K8S_NAMESPACE} -l app=shopdeploy-backend -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}')
                                FRONTEND_READY=\$(kubectl get pods -n ${env.K8S_NAMESPACE} -l app=shopdeploy-frontend -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}')
                                
                                if [[ "\$BACKEND_READY" == *"True"* ]] && [[ "\$FRONTEND_READY" == *"True"* ]]; then
                                    echo "âœ… All pods are healthy"
                                else
                                    echo "âŒ Some pods are not ready"
                                    kubectl describe pods -n ${env.K8S_NAMESPACE}
                                    exit 1
                                fi
                                
                                echo "âœ… Smoke tests passed"
                            """
                        }
                    }
                }
            }
        }

        //======================================================================
        // Stage 8: Integration Tests (Non-Prod Only)
        //======================================================================
        stage('Integration Tests') {
            steps {
                script {
                    if (params.ENVIRONMENT == 'prod') {
                        echo 'â„¹ï¸ Integration tests skipped for production environment'
                    } else if (params.DRY_RUN) {
                        echo 'â„¹ï¸ Dry run mode - skipping integration tests'
                    } else {
                        echo 'ğŸ§ª Running integration tests...'
                        def integrationTestFile = "shopdeploy-backend/tests/integration.test.js"
                        if (fileExists(integrationTestFile)) {
                            dir("shopdeploy-backend") {
                                sh 'npm run test:integration || echo "âš ï¸ Some integration tests failed"'
                            }
                        } else {
                            echo 'â„¹ï¸ No integration tests found, skipping...'
                        }
                    }
                }
            }
        }
    }

    //==========================================================================
    // Post-Build Actions
    //==========================================================================
    post {
        success {
            script {
                if (params.DRY_RUN) {
                    echo "âœ… Dry run completed successfully"
                } else {
                    echo """
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘  âœ… CD PIPELINE COMPLETED SUCCESSFULLY                    â•‘
                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                    â•‘  Environment: ${params.ENVIRONMENT}                       
                    â•‘  Namespace: ${env.K8S_NAMESPACE}                          
                    â•‘  Image Tag: ${env.DEPLOY_IMAGE_TAG}                       
                    â•‘  Duration: ${currentBuild.durationString}                 
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                    
                    // FIX 8: Only send Slack if enabled
                    if (env.SLACK_ENABLED == 'true') {
                        slackSend(
                            channel: '#deployments',
                            color: 'good',
                            message: "âœ… Deployed to ${params.ENVIRONMENT} | Namespace: ${env.K8S_NAMESPACE} | Tag: ${env.DEPLOY_IMAGE_TAG} | Duration: ${currentBuild.durationString}"
                        )
                    } else {
                        echo "ğŸ“¢ Slack not configured â€” skipping notification"
                    }
                }
            }
        }

        failure {
            script {
                echo """
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘  âŒ CD PIPELINE FAILED                                    â•‘
                â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                â•‘  Environment: ${params.ENVIRONMENT}                       
                â•‘  Namespace: ${env.K8S_NAMESPACE}                          
                â•‘  Image Tag: ${env.DEPLOY_IMAGE_TAG}                       
                â•‘  Stage: ${env.STAGE_NAME}                                 
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
                
                // Note: With --atomic flag, Helm auto-rollback is handled automatically
                // Manual rollback code removed as it's now redundant (FIX 6)
                
                // FIX 8: Only send Slack if enabled
                if (env.SLACK_ENABLED == 'true') {
                    slackSend(
                        channel: '#deployments',
                        color: 'danger',
                        message: "âŒ Deploy FAILED: ${params.ENVIRONMENT} | Namespace: ${env.K8S_NAMESPACE} | Tag: ${env.DEPLOY_IMAGE_TAG} | Stage: ${env.STAGE_NAME} | <${BUILD_URL}|View Logs>"
                    )
                } else {
                    echo "ğŸ“¢ Slack not configured â€” skipping notification"
                }
            }
        }

        aborted {
            script {
                echo 'ğŸ›‘ CD Pipeline was aborted'
                // FIX 8: Only send Slack if enabled
                if (env.SLACK_ENABLED == 'true') {
                    slackSend(
                        channel: '#deployments',
                        color: 'warning',
                        message: "ğŸ›‘ Deployment aborted: ${params.ENVIRONMENT} | Tag: ${env.DEPLOY_IMAGE_TAG}"
                    )
                } else {
                    echo "ğŸ“¢ Slack not configured â€” skipping notification"
                }
            }
        }

        always {
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true
            )
        }
    }
}
